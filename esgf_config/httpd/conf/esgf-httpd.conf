# Apache httpd configuration for ESGF applications

# load additional modules
LoadModule ssl_module modules/mod_ssl.so
LoadModule wsgi_module modules/mod_wsgi-py27.so

ServerName my.esgf.node

#Listen 80
<VirtualHost *:80>

  # redirect all requests from HTTP to HTTPS
  # EXCEPT for the applications listed below
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteCond %{REQUEST_URI} !^/esg-search(.*)$
  RewriteCond %{REQUEST_URI} !^/las(.*)$
  RewriteCond %{REQUEST_URI} !^/solr(.*)$
  RewriteCond %{REQUEST_URI} !^/thredds(.*)$
  RewriteCond %{REQUEST_URI} !^/esgf-stats-api(.*)$
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L]

  SSLProxyEngine On

  # proxy /solr requests to Jetty
  ProxyPassMatch  ^/solr(.*)$ http://esgf-solr:8983/solr$1
  ProxyPassReverse /solr      http://esgf-solr:8983/solr

  # proxy /esg-search requests to Tomcat
  ProxyPass /esg-search ajp://esgf-index-node:8009/esg-search
  ProxyPassReverse /esg-search ajp://esgf-index-node:8009/esg-search

  # proxy /thredds requests to Tomcat
  ProxyPass /thredds ajp://esgf-tds:8009/thredds
  ProxyPassReverse /thredds ajp://esgf-tds:8009/thredds

  # proxy /esgf-stats-api requests to Tomcat
  ProxyPass /esgf-stats-api ajp://esgf-data-node:8009/esgf-stats-api
  ProxyPassReverse /esgf-stats-api ajp://esgf-data-node:8009/esgf-stats-api

  # proxy /las requests to Tomcat
  #ProxyPass /las ajp://localhost:8009/las
  #ProxyPassReverse /las ajp://localhost:8009/las

</VirtualHost>

Listen 443
NameVirtualHost *:443
WSGISocketPrefix run/wsgi

<VirtualHost *:443>
  ServerName my.esgf.node

  SSLEngine on
  SSLProxyEngine On

  SSLProtocol -all +tlsv1.2
  SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
  SSLHonorCipherOrder     on


  SSLVerifyClient optional
  SSLVerifyDepth  10
  SSLCertificateFile /etc/certs/hostcert.pem
  SSLCACertificateFile /etc/certs/esgf-ca-bundle.crt
  #SSLCACertificatePath "/etc/trustedcerts/"
  SSLCertificateKeyFile /etc/certs/hostkey.pem
  #SSLCertificateChainFile /etc/certs/cachain.pem
  SSLOptions +StdEnvVars +ExportCertData

  # security headers
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload‚Äù
  Header always set X-Content-Type-Options nosniff
  TraceEnable Off

  RequestHeader set SSL_CLIENT_S_DN "%{SSL_CLIENT_S_DN}s"
  RequestHeader set SSL_CLIENT_I_DN "%{SSL_CLIENT_I_DN}s"
  RequestHeader set SSL_SERVER_S_DN_OU "%{SSL_SERVER_S_DN_OU}s"
  RequestHeader set SSL_CLIENT_VERIFY "%{SSL_CLIENT_VERIFY}s"

  # proxy requests to Jetty
  ProxyPassMatch  ^/solr(.*)$     http://esgf-solr:8983/solr$1
  ProxyPassReverse        /solr   http://esgf-solr:8983/solr

  # proxy requests to Tomcat
  ProxyPass       /esg-orp        ajp://esgf-orp:8009/esg-orp
  ProxyPassReverse /esg-orp       ajp://esgf-orp:8009/esg-orp
  ProxyPass /esgf-idp     ajp://esgf-idp-node:8009/esgf-idp
  ProxyPassReverse /esgf-idp      ajp://esgf-idp-node:8009/esgf-idp
  ProxyPass /esg-search   ajp://esgf-index-node:8009/esg-search
  ProxyPassReverse /esg-search    ajp://esgf-index-node:8009/esg-search
  ProxyPass /thredds      ajp://esgf-tds:8009/thredds
  ProxyPassReverse /thredds       ajp://esgf-tds:8009/thredds
  ProxyPass /esgf-stats-api       ajp://esgf-data-node:8009/esgf-stats-api
  ProxyPassReverse /esgf-stats-api  ajp://esgf-data-node:8009/esgf-stats-api
  # ProxyPass /esgf-dashboard       ajp://localhost:8009/esgf-dashboard
  # ProxyPassReverse /esgf-dashboard        ajp://localhost:8009/esgf-dashboard
  # ProxyPass /esgf-desktop ajp://localhost:8009/esgf-desktop
  # ProxyPassReverse /esgf-desktop  ajp://localhost:8009/esgf-desktop
  # ProxyPass /las  ajp://localhost:8009/las
  # ProxyPassReverse /las   ajp://localhost:8009/las
  
  # proxy requests for slcs resources
  ProxyPass /esgf-slcs http://esgf-slcs:5000 timeout=600
  ProxyPassReverse /esgf-slcs http://esgf-slcs:5000 timeout=600
  ProxyPass /slcs-static http://slcs-nginx timeout=600
  ProxyPassReverse /slcs-static http://slcs-nginx timeout=600

  # Node Manager
  WSGIDaemonProcess esgfnm python-path=/opt/esgf/virtual/python/lib/python2.7/site-packages:/usr/local/esgf-node-manager/src/python/server user=apache group=apache threads=5
  WSGIScriptAlias /esgf-nm /usr/local/esgf-node-manager/src/python/server/nodemgr/apache/wsgi.py
  WSGIPassAuthorization On
  <Directory /usr/local/esgf-nodemgr-doc/code/server/nodemgr/apache>
     Order allow,deny
     Allow from all
     AllowOverride None
  </Directory>
  <Location /esgf-nm>
     WSGIProcessGroup esgfnm
     WSGIApplicationGroup %{GLOBAL}
  </Location>

  # ESGF Authentication Relying Party
  WSGIDaemonProcess esgf_auth python-path=/usr/local/esgf-auth/src/esgf-auth:/usr/local/esgf-auth/venv/lib/python2.7/site-packages
  WSGIScriptAlias /esgf-auth /usr/local/esgf-auth/src/esgf-auth/esgf_auth/wsgi.py process-group=esgf_auth
  WSGIPassAuthorization On
  <Directory /usr/local/esgf-auth/src/esgf-auth/esgf_auth>
      <Files wsgi.py>
          # Apache >= 2.4
          #Require all granted
          # Apache <= 2.2
          Order allow,deny
          Allow from all
      </Files>
  </Directory>
  Alias /esgf-auth/home/static/ /usr/local/esgf-auth/src/esgf-auth/static/
  <Directory /usr/local/esgf-auth/src/esgf-auth/static>
      Options -Indexes
      # Apache >= 2.4
      #Require all granted
      # Apache <= 2.2
      Order allow,deny
      Allow from all
      AllowOverride None
  </Directory>

  # CoG
  # note: WSGIPythonEggs must match location created by Dockerfile
  WSGIDaemonProcess cog-site python-path=/usr/local/cog/venv/lib/python2.7/site-packages:/usr/local/cog/cog-install python-eggs=/var/www/.python-eggs user=apache group=apache threads=25
  WSGIScriptAlias / /usr/local/cog/cog_install/apache/wsgi.py
  WSGIPassAuthorization On
  Alias /static/ /usr/local/cog/cog_install/static/
  <Directory /usr/local/cog/cog_install/static>
      Options -Indexes
      Order deny,allow
      Allow from all
      AllowOverride None
  </Directory>
  WSGIProcessGroup cog-site

</VirtualHost>
