#!/bin/bash

set -eo pipefail

. "$(dirname $BASH_SOURCE)/functions.sh"

#####
## This script outputs YAML configuration for use with the esgf-helm Helm chart
#####

CERTS="/esg/certificates"
SECRETS="/esg/secrets"

# First write the hostname
echo "hostname: $ESGF_HOSTNAME"
echo ""

# Write the certificates YAML file
echo "certificates:"
echo "  esg-trust-bundle.pem: |"
cat "$CERTS/esg-trust-bundle.pem" | indent 4
echo "  hostcert.crt: |"
cat "$CERTS/hostcert/hostcert.crt" | indent 4
echo "  hostcert.key: |"
cat "$CERTS/hostcert/hostcert.key" | indent 4
echo "  slcsca.crt: |"
cat "$CERTS/slcsca/ca.crt" | indent 4
echo "  slcsca.key: |"
cat "$CERTS/slcsca/ca.key" | indent 4
echo ""

# Write the secrets YAML file
echo "secrets:"
for file in $(find "$SECRETS" -type f -maxdepth 1); do
    echo "  ${file#"$SECRETS/"}: $(cat "$file")"
done

