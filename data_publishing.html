<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Data Publishing &mdash; ESGF-Docker Documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ESGF-Docker Documentation" href="index.html" />
    <link rel="next" title="Architecture and Development Guidelines" href="architecture_and_development_guidelines.html" />
    <link rel="prev" title="Multiple Hosts Deployment" href="multiple_hosts_deployment.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="architecture_and_development_guidelines.html" title="Architecture and Development Guidelines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">ESGF-Docker Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="data-publishing">
<h1>Data Publishing<a class="headerlink" href="#data-publishing" title="Permalink to this headline">¶</a></h1>
<p><em>Tested with ESGF_VERSION=1.1</em></p>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This page instructs on how to use the esgf-publisher Python client to
publish a sample dataset and file to the ESGF data node running as a
Docker container. These instructions are meant to be executed inside the
data node container:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose up
docker exec -it -u 0 data-node /bin/bash
</pre></div>
</div>
</div>
<div class="section" id="one-time-setup">
<h2>One-Time Setup<a class="headerlink" href="#one-time-setup" title="Permalink to this headline">¶</a></h2>
<p>When it is first initialized, the TDS main catalog contains references
to its internal test datasets. This catalog must be replaced with the
standard ESGF main catalog (which is mounted onto the container as part
of the Docker distribution):</p>
<div class="highlight-python"><div class="highlight"><pre>cd /esg/content/thredds
mv catalog.xml-esgcet catalog.xml
</pre></div>
</div>
<p>Also, the postgres database must be initialized with the list of models,
experiments found in the file <em>esgcet_models_table.xml</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /esg/config/esgcet
source ${CDAT_HOME}/bin/activate esgf-pub
esginitialize -c
</pre></div>
</div>
<p>(this step must actually be repeated any time that file changes).</p>
<p>The test file to be published should already be present at the location:
<em>/esg/data/test/sftlf.nc</em> . If not, it can be downloaded as:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p /esg/data/test
cd /esg/data/test
wget -O sftlf.nc http://distrib-coffee.ipsl.jussieu.fr/pub/esgf/dist/externals/sftlf.nc
</pre></div>
</div>
</div>
<div class="section" id="step-1">
<h2>Step 1<a class="headerlink" href="#step-1" title="Permalink to this headline">¶</a></h2>
<p>Generate the mapfile listing the dataset and files to be published:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /esg/config/esgcet
source ${CDAT_HOME}/bin/activate esgf-pub
esgprep mapfile --project test /esg/data/test
ls -l test.test.map
</pre></div>
</div>
</div>
<div class="section" id="step-2">
<h2>Step 2<a class="headerlink" href="#step-2" title="Permalink to this headline">¶</a></h2>
<p>Publish to the postgres database:</p>
<div class="highlight-python"><div class="highlight"><pre>esgpublish --project test --map test.test.map --service fileservice
esglist_datasets test
</pre></div>
</div>
</div>
<div class="section" id="step-3">
<h2>Step 3<a class="headerlink" href="#step-3" title="Permalink to this headline">¶</a></h2>
<p>Publish to the TDS:</p>
<div class="highlight-python"><div class="highlight"><pre>esgpublish --project test --map test.test.map --service fileservice --noscan --thredds
</pre></div>
</div>
<p>Note: this operation will use the credentials contained in the <em>esg.ini</em>
file to invoke the TDS re-initialization URL:</p>
<ul class="simple">
<li><a class="reference external" href="https://my-node.esgf.org:8443/thredds/admin/debug?Catalogs/reinit">https://my-node.esgf.org:8443/thredds/admin/debug?Catalogs/reinit</a> .</li>
</ul>
<p>After the operation completes, the file should be accessible starting
from the TDS main catalog page:</p>
<ul class="simple">
<li><a class="reference external" href="http://my-node.esgf.org/thredds/catalog/catalog.html">http://my-node.esgf.org/thredds/catalog/catalog.html</a></li>
</ul>
<p>and downloadable using any openid, password combination that is trusted
by the data-node. The authorization required for downloading the file is
specified in the access policy file: <em>/esg/config/esgf_policies_local.xml</em>
as an XML statement of the form:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;policy resource=&quot;.*test.*&quot; attribute_type=&quot;AUTH_ONLY&quot; attribute_value=&quot;&quot; action=&quot;Read&quot;/&gt;
</pre></div>
</div>
</div>
<div class="section" id="step-4">
<h2>Step 4<a class="headerlink" href="#step-4" title="Permalink to this headline">¶</a></h2>
<p>Publish to Solr. Note: this step cannot be properly completed until the
ESGF/Docker data stack contains a MyProxy server (or other substitute)
that is able to issue short term X509 certificates for users managed by
the identity provider container. In the meantime, the following
workarounds can be adopted.</p>
<p>Obtain a short-term X509 certificate from any other trusted ESGF
identity provider, and copy it into the data-node container in the location
referenced by the file esg.ini:</p>
<div class="highlight-python"><div class="highlight"><pre>cp certificate-file /root/.globus/certificate-file
</pre></div>
</div>
<p>Then, disable specific authorization for publishing test data, requiring only
the availability of an X509 certificate. Edit the file: <em>/esg/config/esgf_policies_local.xml</em>
and insert the following policy statement (as XML):</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;policy resource=&quot;.*test.*&quot; attribute_type=&quot;ANY&quot; attribute_value=&quot;&quot; action=&quot;Write&quot;/&gt;
</pre></div>
</div>
<p>At this point, you can issue the publishing command:</p>
<div class="highlight-python"><div class="highlight"><pre>esgpublish --project test --map test.test.map --service fileservice --noscan --publish
</pre></div>
</div>
<p>After about a minute, the dataset and file should be returned when
querying the &#8220;slave&#8221; Solr index:</p>
<ul class="simple">
<li><a class="reference external" href="http://my-node.esgf.org/solr/#/datasets/query">http://my-node.esgf.org/solr/#/datasets/query</a></li>
<li><a class="reference external" href="http://my-node.esgf.org/solr/#/files/query">http://my-node.esgf.org/solr/#/files/query</a></li>
</ul>
<p>Additionally, they should be returned when initiating a search from the
CoG user interface, if the project has searching enabled:</p>
<ul class="simple">
<li><a class="reference external" href="https://my-node.esgf.org/search/testproject/">https://my-node.esgf.org/search/testproject/</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Data Publishing</a><ul>
<li><a class="reference internal" href="#description">Description</a></li>
<li><a class="reference internal" href="#one-time-setup">One-Time Setup</a></li>
<li><a class="reference internal" href="#step-1">Step 1</a></li>
<li><a class="reference internal" href="#step-2">Step 2</a></li>
<li><a class="reference internal" href="#step-3">Step 3</a></li>
<li><a class="reference internal" href="#step-4">Step 4</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="multiple_hosts_deployment.html"
                        title="previous chapter">Multiple Hosts Deployment</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="architecture_and_development_guidelines.html"
                        title="next chapter">Architecture and Development Guidelines</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/data_publishing.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="architecture_and_development_guidelines.html" title="Architecture and Development Guidelines"
             >next</a> |</li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             >previous</a> |</li>
        <li><a href="index.html">ESGF-Docker Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, ESGF.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b2.
    </div>
  </body>
</html>