<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Single Host Deployment &mdash; ESGF-Docker Documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ESGF-Docker Documentation" href="index.html" />
    <link rel="next" title="Multiple Hosts Deployment" href="multiple_hosts_deployment.html" />
    <link rel="prev" title="Table of Contents:" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Table of Contents:"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">ESGF-Docker Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="single-host-deployment">
<h1>Single Host Deployment<a class="headerlink" href="#single-host-deployment" title="Permalink to this headline">¶</a></h1>
<p><em>Tested with ESGF_VERSION=1.1</em></p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>The following instructions explain how to run an ESGF node as a set of
interacting Docker containers on a single host (for example, a Linux VM,
a MacOSX laptop, etc.). Docker Engine must be up and running before
proceeding.</p>
</div>
<div class="section" id="pre-requisites">
<h2>Pre-Requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A host system with the latest version of Docker Engine installed (at
this time, Docker 1.12+). Tested on MacOSX and Linux CentOS.</li>
<li>Java SDK (at this time 1.8), keytool is required.</li>
</ul>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Clone the current repository, cd to the top-level directory. Checkout
the latest stable branch, which is named &#8220;vN.M&#8221; (for example, &#8220;v1.1&#8221;).</p>
<div class="highlight-python"><div class="highlight"><pre>git clone https://github.com/ESGF/esgf-docker.git
cd esgf-docker
git tag -l
git checkout vN.M
</pre></div>
</div>
<p>Note: if you want to create a new branch based on a tag, use the command:</p>
<div class="highlight-python"><div class="highlight"><pre>git checkout tags/&lt;tag_name&gt; -b &lt;branch_name&gt;
</pre></div>
</div>
</li>
<li><p class="first">Define your environment:</p>
<ul class="simple">
<li><strong>ESGF_HOSTNAME</strong> must reference the Fully Qualified Domain Name of the host where the containers will be running:</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">on linux, use the actual server host name:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_HOSTNAME=`hostname`
</pre></div>
</div>
</li>
<li><p class="first">on mac, choose a custom host name, and bind it to the current IP address of the Mac, for example:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_HOSTNAME=my-node.esgf.org
</pre></div>
</div>
<p>You must edit <em>/private/etc/hosts</em> and map <em>my-node.esgf.org</em> to the current Mac IP address
(which you can find from the Control Panel Network Settings), for example:</p>
<div class="highlight-python"><div class="highlight"><pre>cat /private/etc/hosts
...
192.168.0.5 my-node.esgf.org
</pre></div>
</div>
</li>
<li><p class="first">on mac using docker-machine:</p>
<ul>
<li><p class="first">set ESGF_HOSTNAME, for example:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_HOSTNAME=my-esgf-node
</pre></div>
</div>
</li>
<li><p class="first">create a docker-machine with a name that matches a chosen ESGF_HOSTNAME, for example:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-machine create --driver virtualbox --virtualbox-memory=4096 --virtualbox-cpu-count=2 my-esgf-node
</pre></div>
</div>
</li>
<li><p class="first">determine the IP address of the new docker-machine:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-machine ip my-esgf-node
</pre></div>
</div>
</li>
<li><p class="first">edit <em>/private/etc/hosts</em> and map <em>my-esgf-node</em> to the docker-machine IP address, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre>cat /private/etc/hosts
...
192.168.99.101  my-esgf-node
</pre></div>
</div>
</li>
<li><p class="first">make sure to run:</p>
<div class="highlight-python"><div class="highlight"><pre>eval $(docker-machine env my-esgf-node)
</pre></div>
</div>
<p>to ensure your docker commands use the new docker-machine and not the default.</p>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<ul>
<li><p class="first"><strong>ESGF_CONFIG</strong> must reference a directory on the host system that will store
all the site-specific configuration, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_CONFIG=~/esgf_config
mkdir -p $ESGF_CONFIG
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_DATA_DIR</strong> must reference the root of the data directory on your host.</p>
<ul>
<li><p class="first">for example on linux:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_DATA_DIR=/esgf/data
</pre></div>
</div>
</li>
<li><p class="first">for example on mac:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_DATA_DIR=~/esgf_data
</pre></div>
</div>
<p>(since on a mac the Docker engine only has access to the filesystem under the user home directory).</p>
</li>
</ul>
<p>Then create the directory if not existing already:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p $ESGF_DATA_DIR
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_VERSION</strong> is the version of the ESGF/Docker stack to be used,
which is recommended to be the latest stable version, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_VERSION=1.1
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Initialize your node configuration: create a self-signed certificate
for $ESGF_HOSTNAME and populate the $ESGF_CONFIG directory with initial content. From the scripts/ directory:</p>
<div class="highlight-python"><div class="highlight"><pre>./esgf_node_init.sh
ls -l $ESGF_CONFIG
</pre></div>
</div>
<p>Note: if you are going through these instructions more than one time,
make sure you don&#8217;t have previous containers that were configured with a different version of the certificates.
So before re-initializing the node, make sure to stop all running containers. It might be also useful to remove all previously created volumes. From
the top-level <em>esgf-docker/</em> directory, issue the commands:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose down
docker rm $(docker ps -a -q)
docker volume ls -qf dangling=true | xargs docker volume rm
</pre></div>
</div>
<p>Note: it&#8217;s been observed that the Docker engine on a mac might not track time correctly
if the mac goes into sleep mode, which may cause problems with the validity of the certificates.
To bypass this issue, restart the Docker engine after generating the certificates.</p>
</li>
</ul>
</div>
<div class="section" id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Optional: pre-download the latest version of all ESGF Docker images.
If not done now, the images will be pulled down automatically one by
one when each service is started. Note that downloading or
pre-downloading all the images (which amount to several GBs) may take
a considerable time, depending on your internet connection. From the <em>scripts/</em> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>./docker_pull_all.sh $ESGF_VERSION
</pre></div>
</div>
</li>
<li><p class="first">Start all ESGF services in daemon mode, then look at the combined
logs. Even if the images have been pre-download, starting all the
services the first time may take a few minutes as the host system is
allocating memory, disk space, and initializing each service.</p>
<ul>
<li><p class="first">if you have pre-downloaded the images, issue:</p>
<div class="highlight-python"><div class="highlight"><pre>docker images
</pre></div>
</div>
<p>to make sure the version of the images matches what you expect from $ESGF_VERSION</p>
</li>
<li><p class="first">from the top-level <em>esgf-docker/</em> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose up -d
docker-compose logs -f
docker ps
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Do some testing. Note that you will have to instruct your browser to
trust the self-signed certificate from $ESGF_HOSTNAME.</p>
<ul>
<li><p class="first">In a browser, access the top-level CoG page for the node:</p>
<div class="highlight-python"><div class="highlight"><pre>https://$ESGF_HOSTNAME/
</pre></div>
</div>
</li>
<li><p class="first">Login with the <em>rootAdmin</em> openid:</p>
<div class="highlight-python"><div class="highlight"><pre>https://$ESGF_HOSTNAME/esgf-idp/openid/rootAdmin
</pre></div>
</div>
<p>and use the password: <em>changeit</em> .</p>
</li>
<li><p class="first">Access the top-level TDS catalog:</p>
<div class="highlight-python"><div class="highlight"><pre>http://$ESGF_HOSTNAME/thredds
</pre></div>
</div>
</li>
<li><p class="first">Download one of the test files.
You will have to log onto the ORP with the same openid as above.</p>
</li>
</ul>
</li>
<li><p class="first">Change the ESGF root password. You must first stop the containers,
then run a script that picks up the new password from an environment
variable. This must be done after the containers have been started at
least once, because the initial default password is hard-coded into the postgres image.</p>
<ul>
<li><p class="first">From the top-level <em>esgf-docker/</em> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose stop
</pre></div>
</div>
</li>
<li><p class="first">For example, set the new password to:</p>
<div class="highlight-python"><div class="highlight"><pre>export ESGF_PASSWORD=abc123
</pre></div>
</div>
</li>
<li><p class="first">From the <em>scripts/</em> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>./change_password.sh
</pre></div>
</div>
</li>
<li><p class="first">Restart the ESGF services to make sure everything still works:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose up -d
</pre></div>
</div>
<p>Note that the above operation will change the ESGF password for all
modules, except for the password used by the <em>rootAdmin</em> openid to log
onto the web (this is by design, so that the two passwords can be
different). This last password can be changed through the CoG
interface once <em>rootAdmin</em> is logged in.</p>
</li>
<li><p class="first">Stop all services, and optionally remove all containers and associated data volumes:</p>
<div class="highlight-python"><div class="highlight"><pre>docker-compose stop
# optional:
docker-compose down
# optional:
docker volume ls -qf dangling=true \| xargs docker volume rm
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Single Host Deployment</a><ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pre-requisites">Pre-Requisites</a></li>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#execution">Execution</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Table of Contents:</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="multiple_hosts_deployment.html"
                        title="next chapter">Multiple Hosts Deployment</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/single_host_deployment.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Table of Contents:"
             >previous</a> |</li>
        <li><a href="index.html">ESGF-Docker Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, ESGF.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b2.
    </div>
  </body>
</html>