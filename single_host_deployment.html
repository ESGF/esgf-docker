<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Single Host Deployment &mdash; ESGF-Docker Documentation 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ESGF-Docker Documentation 1.0 documentation" href="index.html" />
    <link rel="next" title="Multiple Hosts Deployment" href="multiple_hosts_deployment.html" />
    <link rel="prev" title="ESGF-Containers documentation" href="index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>ESGF-Docker Documentation 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Single Host Deployment</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="index.html">ESGF-Containers documentation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="multiple_hosts_deployment.html">Multiple Hosts Deployment</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="single-host-deployment">
<h1>Single Host Deployment<a class="headerlink" href="#single-host-deployment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>The following instructions explain how to run an ESGF node as a set of
interacting Docker containers on a single host (for example, a Linux VM,
a MacOSX laptop, etc.). Docker Engine must be up and running before
proceeding.</p>
</div>
<div class="section" id="pre-requisites">
<h2>Pre-Requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A host system with the latest version of Docker Engine installed (at
this time, Docker 1.12+). Tested on MacOSX and Linux CentOS.</li>
<li>Java SDK (at this time 1.8), keytool is required.</li>
<li>Docker-compose (at this time 1.14.0), installation procedure
<a class="reference external" href="https://docs.docker.com/compose/install/#install-compose">here</a></li>
</ul>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Clone the current repository, cd to the top-level directory. Checkout
the latest stable branch, which is named &#8220;vN.M&#8221; (for example,
&#8220;v1.1&#8221;),</li>
<li><code class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/ESGF/esgf-docker.git</span></code></li>
<li><code class="docutils literal"><span class="pre">cd</span> <span class="pre">esgf-docker</span></code></li>
<li><code class="docutils literal"><span class="pre">git</span> <span class="pre">tag</span> <span class="pre">-l</span></code></li>
<li><code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">vN.M</span></code> (if you want to create a new branch based on a
tag, use the command
<code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">tags/&lt;tag_name&gt;</span> <span class="pre">-b</span> <span class="pre">&lt;branch_name&gt;</span></code>)</li>
<li>Define your environment:</li>
<li>ESGF_HOSTNAME must reference the Fully Qualified Domain Name of the
host where the containers will be running:<ul>
<li>on linux - use the actual server host name:</li>
<li>export ESGF_HOSTNAME=`hostname`</li>
<li>on mac - choose a custom host name, and bind it to the current IP
address of the Mac, for example:</li>
<li>export ESGF_HOSTNAME=my-node.esgf.org</li>
<li>edit /private/etc/hosts and map my-node.esgf.org to the current
Mac IP address (which you can find from the Control Panel -
Network Settings), for example: 192.168.0.5 my-node.esgf.org</li>
<li>on mac using docker-machine</li>
<li>set ESGF_HOSTNAME. E.g. <code class="docutils literal"><span class="pre">export</span> <span class="pre">ESGF_HOSTNAME=my-esgf-node</span></code></li>
<li>create a docker-machine with a name that matches a chosen
ESGF_HOSTNAME. E.g.
<code class="docutils literal"><span class="pre">docker-machine</span> <span class="pre">create</span> <span class="pre">--driver</span> <span class="pre">virtualbox</span> <span class="pre">--virtualbox-memory=4096</span> <span class="pre">--virtualbox-cpu-count=2</span> <span class="pre">my-esgf-node</span></code></li>
<li>determine the IP address of the new docker-machine
<code class="docutils literal"><span class="pre">docker-machine</span> <span class="pre">ip</span> <span class="pre">my-esgf-node</span></code></li>
<li>edit <code class="docutils literal"><span class="pre">/private/etc/hosts</span></code> and map <code class="docutils literal"><span class="pre">my-esgf-node</span></code> to the
docker-machine ip address. E.g. <code class="docutils literal"><span class="pre">192.168.99.101</span>&nbsp; <span class="pre">my-esgf-node</span></code></li>
<li>make sure to run <code class="docutils literal"><span class="pre">eval</span> <span class="pre">$(docker-machine</span> <span class="pre">env</span> <span class="pre">my-esgf-node)</span></code> to
ensure your docker commands use the new docker-machine and not the
default.</li>
</ul>
</li>
<li>ESGF_CONFIG must reference a directory on the host system that will
store all the site-specific configuration:<ul>
<li>for example: export ESGF_CONFIG=~/esgf_config</li>
<li>mkdir -p $ESGF_CONFIG</li>
</ul>
</li>
<li>ESGF_DATA_DIR must reference the root of the data directory on your
host<ul>
<li>for example on linux: export ESGF_DATA_DIR=/esgf/data</li>
<li>for example on mac: export ESGF_DATA_DIR= ~/esgf_data (since on
a mac the Docker engine only has access to the filesystem under
the user home directory)</li>
<li>mkdir -p $ESGF_DATA_DIR</li>
</ul>
</li>
<li>ESGF_VERSION is the version of the ESGF/Docker stack to be used,
which is recommended to be the latest stable version<ul>
<li>for example: export ESGF_VERSION=1.1</li>
</ul>
</li>
<li>Initialize your node configuration: create a self-signed certificate
for $ESGF_HOSTNAME and populate the $ESGF_CONFIG directory with
initial content.</li>
<li>from the scripts/ directory:<ul>
<li>./esgf_node_init.sh</li>
<li>ls -l $ESGF_CONFIG</li>
</ul>
</li>
<li>Note: if you are going through these instructions more than one time,
make sure you don&#8217;t have previous containers that were configured
with a different version of the certificates. So before
re-initializing the node, issue a &#8220;docker-compose down&#8221; command from
the top level esgf-docker/ directory. It might be also useful to
remove all previously created volumes:<ul>
<li>docker-compose down (or: docker rm $(docker ps -a -q))</li>
<li>docker volume ls -qf dangling=true | xargs docker volume rm</li>
</ul>
</li>
<li>Note: it&#8217;s been observed that the Docker engine on a mac might not
track time correctly if the mac goes into sleep mode, which may cause
problems with the validity of the certificates. To bypass this issue,
restart the Docker engine after generating the certificates.</li>
</ul>
</div>
<div class="section" id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Optional: pre-download the latest version of all ESGF Docker images.
If not done now, the images will be pulled down automatically one by
one when each service is started. Note that downloading or
pre-downloading all the images (which amount to several GBs) may take
a considerable time, depending on your internet connection.</li>
<li>from the scripts/ directory: ./docker_pull_all.sh $ESGF_VERSION</li>
<li>Start all ESGF services in daemon mode, then look at the combined
logs. Even if the images have been pre-download, starting all the
services the first time may take a few minutes as the host system is
allocating memory, disk space, and initializing each service.</li>
<li>if you have pre-downloaded the images, issue: &#8216;docker images&#8217; to make
sure the version of the images matches what you expect from
$ESGF_VERSION</li>
<li>from the top-level esgf-docker/ directory:<ul>
<li>docker-compose up -d</li>
<li>docker-compose logs -f</li>
<li>docker ps (display informations on running containers)</li>
</ul>
</li>
<li>Do some testing. Note that you will have to instruct your browser to
trust the self-signed certificate from $ESGF_HOSTNAME.</li>
<li>In a browser, access the top-level CoG page for the node:
<a class="reference external" href="https://$ESGF_HOSTNAME/">https://$ESGF_HOSTNAME/</a></li>
<li>Login with the rootAdmin openid:
<a class="reference external" href="https://$ESGF_HOSTNAME/esgf-idp/openid/rootAdmin">https://$ESGF_HOSTNAME/esgf-idp/openid/rootAdmin</a> (password:
changeit)</li>
<li>Access the top-level TDS catalog: <a class="reference external" href="http://$ESGF_HOSTNAME/thredds">http://$ESGF_HOSTNAME/thredds</a></li>
<li>Download one of the test files. You will have to log onto the ORP
with the same openid as above.</li>
<li>Change the ESGF root password. You must first stop the containers,
then run a script that picks up the new password from an environment
variable. This must be done after the containers have been started at
least once, because the initial default password is hard-coded into
the postgres image.</li>
<li>from the top-level esgf/ directory: docker-compose stop</li>
<li>for example, export ESGF_PASSWORD=abc123</li>
<li>from the scripts/ directory: ./change_password.sh</li>
<li>restart the ESGF services to make sure everything still works:
docker-compose up -d</li>
<li>Note that the above operation will change the ESGF password for all
modules, except for the password used by the rootAdmin openid to log
onto the web (this is by design, so that the two passwords can be
different). This last password can be changed through the CoG
interface once rootAdmin is logged in.</li>
<li>Stop all services, and optionally remove all containers and
associated data volumes:</li>
<li>docker-compose stop</li>
<li>optional: docker-compose down</li>
<li>optional: docker volume ls -qf dangling=true | xargs docker volume
rm</li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="index.html">ESGF-Containers documentation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="multiple_hosts_deployment.html">Multiple Hosts Deployment</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, ESGF.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b2.
    </div>
  </body>
</html>