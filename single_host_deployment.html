<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Single Host Deployment &#8212; ESGF-Docker Documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multiple Hosts Deployment" href="multiple_hosts_deployment.html" />
    <link rel="prev" title="Table of Contents:" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Table of Contents:"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ESGF-Docker Documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="single-host-deployment">
<span id="id1"></span><h1>Single Host Deployment<a class="headerlink" href="#single-host-deployment" title="Permalink to this headline">¶</a></h1>
<p><em>Tested with ESGF_VERSION=1.4</em></p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>The following instructions explain how to run an ESGF node as a set of
interacting Docker containers on a single host (for example, a Linux VM,
a MacOSX laptop, etc.). Docker Engine must be up and running before
proceeding.</p>
</div>
<div class="section" id="pre-requisites">
<h2>Pre-Requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A host system with the latest version of Docker Engine installed (at
this time, Docker 1.17.x). Tested on MacOSX (Version 17.09.1-ce-mac42) and Linux CentOS.</li>
<li>Java SDK (at this time 1.8), keytool is required (add it to the PATH var env).</li>
<li>Docker Compose (at this time 1.17.x), installation procedure
<a class="reference external" href="https://docs.docker.com/compose/install/#install-compose">here</a>
(on a Mac, Compose is automatically installed as part of the standard Docker installation).</li>
</ul>
</div>
<div class="section" id="cleanup">
<h2>Cleanup<a class="headerlink" href="#cleanup" title="Permalink to this headline">¶</a></h2>
<p>If you are following these instructions <em>not</em> for the first time,
it might be a good idea to completely reset the system so you can start from a clean slate. To do so,
stop all running containers, and remove all data volumes and all configuration.
From the top-level <em>esgf-docker/</em> directory, issue the commands:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>docker-compose down
docker rm $(docker ps -a -q)
docker volume ls -qf dangling=true | xargs docker volume rm
rm -rf $ESGF_CONFIG/*
</pre></div>
</div>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Clone the current repository, cd to the top-level directory. Checkout
the master branch, which is the latest stable branch:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ESGF</span><span class="o">/</span><span class="n">esgf</span><span class="o">-</span><span class="n">docker</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">esgf</span><span class="o">-</span><span class="n">docker</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">master</span>
</pre></div>
</div>
</li>
<li><p class="first">Define your environment. Note that on a Mac the Docker engine has access only to the filesystem under the user home directory,
so all environment variables that reference directories must use paths under the user home directory.</p>
<ul>
<li><p class="first">Add the path to the keytool install directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export PATH=&#39;/path/to/keytool/install/dir&#39;:$PATH
which keytool
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_HOSTNAME</strong> must reference the Fully Qualified Domain Name of the host where the containers will be running:</p>
</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">On linux, use the actual server host name:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export ESGF_HOSTNAME=`hostname`
</pre></div>
</div>
</li>
<li><p class="first">On mac, choose a custom host name, and bind it to the current IP address of the Mac, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export ESGF_HOSTNAME=my-node.esgf.org
echo $ESGF_HOSTNAME
</pre></div>
</div>
<p>You must edit <em>/private/etc/hosts</em> and map <em>my-node.esgf.org</em> to the current Mac IP address
(which you can find from the Control Panel Network Settings), for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="o">...</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">0.5</span> <span class="n">my</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">esgf</span><span class="o">.</span><span class="n">org</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<ul>
<li><p class="first"><strong>ESGF_CONFIG</strong> must reference a directory on the host system that will store
all the site-specific configuration, e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export ESGF_CONFIG=~/esgf_config
mkdir -p $ESGF_CONFIG
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_VERSION</strong> must specify the version of the ESGF/Docker stack to be used,
which is recommended to be the latest stable version, e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ESGF_VERSION</span><span class="o">=</span><span class="mf">1.4</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_IMAGES_HUB</strong> must reference the name of the Docker repository to pull the images from, which for this
exercise should be <em>esgfhub</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ESGF_IMAGES_HUB</span><span class="o">=</span><span class="n">esgfhub</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>ESGF_DATA_DIR</strong> must reference the root of the data directory on your host.</p>
<ul>
<li><p class="first">for example on linux:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ESGF_DATA_DIR</span><span class="o">=/</span><span class="n">esgf</span><span class="o">/</span><span class="n">data</span>
</pre></div>
</div>
</li>
<li><p class="first">for example on mac:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ESGF_DATA_DIR</span><span class="o">=~/</span><span class="n">esgf_data</span>
</pre></div>
</div>
</li>
</ul>
<p>Then create the directory if not existing already:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir -p $ESGF_DATA_DIR
</pre></div>
</div>
<p>Note that this location is currently not really used to store any data.</p>
</li>
</ul>
</li>
<li><p class="first">Initialize your node configuration: create a self-signed certificate
for $ESGF_HOSTNAME and populate the $ESGF_CONFIG directory with initial content:</p>
<p>Note: if you are on a Mac, ensure <strong>gtar</strong> and <strong>xz</strong> utilities are installed before running the <code class="code docutils literal"><span class="pre">esgf_node_init.sh</span></code> script:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>./scripts/esgf_node_init.sh
ls -l $ESGF_CONFIG
</pre></div>
</div>
<p>Note: it&#8217;s been observed that the Docker engine on a mac might not track time correctly
if the mac goes into sleep mode, which may cause problems with the validity of the certificates.
To bypass this issue, restart the Docker engine after generating the certificates.</p>
</li>
</ul>
</div>
<div class="section" id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Optional: pre-download the latest version of all ESGF Docker images.
If not done now, the images will be pulled down automatically one by
one when each service is started. Note that downloading or
pre-downloading all the images (which amount to several GBs) may take
a considerable time, depending on your internet connection.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>./scripts/docker_pull_all.sh $ESGF_VERSION
docker images | grep $ESGF_VERSION
</pre></div>
</div>
<p>Make sure the hash of each image is what you would expect from the $ESGF_VERSION you are using.</p>
</li>
<li><p class="first">Start all ESGF services in daemon mode, then look at the combined
logs. Even if the images have been pre-download, starting all the
services the first time may take a few minutes as the host system is
allocating memory, disk space, and initializing each service.
From the top-level <em>esgf-docker/</em> directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
<span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">logs</span> <span class="o">-</span><span class="n">f</span>
<span class="c1"># in another terminal:</span>
<span class="n">docker</span> <span class="n">ps</span>
</pre></div>
</div>
</li>
<li><p class="first">Do some testing. Note that you will have to instruct your browser to
trust the self-signed certificate from $ESGF_HOSTNAME.</p>
<ul>
<li><p class="first">In a browser, access the top-level CoG page for the node:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://$ESGF_HOSTNAME/
</pre></div>
</div>
</li>
<li><p class="first">Login with the <em>rootAdmin</em> openid:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://$ESGF_HOSTNAME/esgf-idp/openid/rootAdmin
</pre></div>
</div>
<p>and use the password: <em>changeit</em> .</p>
</li>
<li><p class="first">Access the top-level TDS catalog:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>http://$ESGF_HOSTNAME/thredds
</pre></div>
</div>
</li>
<li><p class="first">Re-initialize the TDS catalogs:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://$ESGF_HOSTNAME/thredds/admin/debug?Catalogs/reinit
</pre></div>
</div>
<p>Use username = <em>dnode_user</em> and password = <em>changeit</em> .</p>
</li>
<li><p class="first">Download one of the test files.
You will have to log onto the ORP with the same openid as above.</p>
</li>
<li><p class="first">Test the Solr admin interface:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://$ESGF_HOSTNAME/solr
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first"><strong>NOTE: changing password not currently working in ESGF_VERSION=1.4: will be fixed in ESGF_VERSION=1.5.</strong></p>
<p>Change the ESGF root password. You must first stop the containers,
then run a script that picks up the new password from an environment
variable. This must be done after the containers have been started at
least once, because the initial default password is hard-coded into the postgres image.</p>
<ul>
<li><p class="first">From the top-level <em>esgf-docker/</em> directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">For example, set the new password to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ESGF_PASSWORD</span><span class="o">=</span><span class="n">abc123</span>
</pre></div>
</div>
</li>
<li><p class="first">Change the password:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">change_password</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
<li><p class="first">Restart the ESGF services to make sure everything still works:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>Note that the above operation will change the ESGF password for all
modules, except for the password used by the <em>rootAdmin</em> openid to log
onto the web (this is by design, so that the two passwords can be
different). This last password can be changed through the CoG
interface once <em>rootAdmin</em> is logged in.</p>
</li>
</ul>
</li>
<li><p class="first">Stop all services, and optionally remove all containers and associated data volumes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">stop</span>
<span class="c1"># optional:</span>
<span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">down</span>
<span class="c1"># optional:</span>
<span class="n">docker</span> <span class="n">volume</span> <span class="n">ls</span> <span class="o">-</span><span class="n">qf</span> <span class="n">dangling</span><span class="o">=</span><span class="n">true</span> \<span class="o">|</span> <span class="n">xargs</span> <span class="n">docker</span> <span class="n">volume</span> <span class="n">rm</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Single Host Deployment</a><ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pre-requisites">Pre-Requisites</a></li>
<li><a class="reference internal" href="#cleanup">Cleanup</a></li>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#execution">Execution</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Table of Contents:</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="multiple_hosts_deployment.html"
                        title="next chapter">Multiple Hosts Deployment</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/single_host_deployment.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="multiple_hosts_deployment.html" title="Multiple Hosts Deployment"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Table of Contents:"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ESGF-Docker Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, ESGF.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>